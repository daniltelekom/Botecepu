// ====== ДАННЫЕ УРОКОВ / ТЕСТОВ ======

const lessonsData = {
  operator: [
    // ---------- МОДУЛЬ 1: О компании ----------
    {
      id: "op_module_1",
      title: "1. Кто мы и что делаем",
      short: "Базовое понимание компании и услуг",
      description:
        "Разберём, чем занимается ООО «ЕЦПУ», какие услуги оказываем и как объяснять это клиенту простым языком.",
      content: [
        { type: "title", text: "О компании ООО «ЕЦПУ»" },
        {
          type: "text",
          text:
            "ООО «ЕЦПУ» занимается поверкой, заменой и установкой приборов учёта (счётчиков), а также сантехническими и электрическими работами. " +
            "Оператор принимает звонок, оформляет заявку, а мастер выезжает к клиенту и выполняет работу."
        },
        { type: "title", text: "Что такое поверка, замена и установка" },
        {
          type: "list",
          items: [
            "Поверка — проверяем, правильно ли считает счётчик, без замены самого счётчика.",
            "Замена — снимаем старый счётчик и устанавливаем новый.",
            "Установка — ставим счётчик там, где его раньше не было."
          ]
        },
        { type: "title", text: "Сантехнические и электрические работы" },
        {
          type: "list",
          items: [
            "Сантехника: замена кранов, гибких подводок, вентилей, устранение протечек и т.п.",
            "Электрика: розетки, выключатели, автоматы, щитки и другие работы по электропроводке."
          ]
        },
        { type: "title", text: "Принципы общения с клиентом" },
        {
          type: "list",
          items: [
            "Говорим спокойно, вежливо и понятным языком.",
            "Не спорим с клиентом, не повышаем голос.",
            "Не обещаем того, чего компания не делает или не может гарантировать.",
            "Если не уверены — лучше уточнить у старшего, чем придумать ответ."
          ]
        }
      ],
      test: [
        {
          question: "Что чаще всего оформляет оператор ООО «ЕЦПУ»?",
          options: ["Поверку счётчиков", "Доставку еды", "Ремонт автомобилей", "Перевозку мебели"],
          correctIndex: 0
        },
        {
          question: "Что такое поверка счётчика?",
          options: [
            "Замена старого счётчика на новый",
            "Проверка, правильно ли считает счётчик",
            "Установка счётчика, которого раньше не было",
            "Промывка труб"
          ],
          correctIndex: 1
        },
        {
          question: "Что из этого относится к сантехническим работам?",
          options: ["Замена кранов", "Настройка Wi-Fi", "Ремонт телевизора", "Установка антенны"],
          correctIndex: 0
        }
      ]
    },

    // ---------- МОДУЛИ 2.1–2.8: ПРОГРАММА AZIMUT.ECPU ----------

    // 2.1
    {
      id: "op_module_2_1",
      title: "2.1. Запуск программы и вход",
      short: "Azimut.ECPU и телефония",
      description:
        "Разберём, какие программы нужны оператору, как запускать Azimut.ECPU и входить под своим логином.",
      content: [
        { type: "title", text: "Какие программы использует оператор" },
        {
          type: "list",
          items: [
            "Основная программа учёта заявок — Azimut.ECPU.",
            "Телефония — программа для совершения звонков клиентам.",
            "Обычно ярлыки этих программ находятся на рабочем столе."
          ]
        },
        { type: "title", text: "Вход в Azimut.ECPU" },
        {
          type: "text",
          text:
            "Для начала работы оператор запускает Azimut.ECPU и вводит свой логин и пароль. " +
            "Логин и пароль выдаются ответственным сотрудником компании. Нельзя передавать их другим людям."
        },
        { type: "image", src: "images/op_21_login_placeholder.png", caption: "Окно входа в Azimut.ECPU." },
        { type: "title", text: "Если не получается войти" },
        {
          type: "list",
          items: [
            "Проверяем раскладку клавиатуры и наличие включённого Caps Lock.",
            "Аккуратно вводим логин и пароль ещё раз, без пробелов.",
            "Если снова не получилось — обращаемся к старшему оператору или администратору."
          ]
        }
      ],
      test: [
        {
          question: "Какие две программы оператор использует постоянно?",
          options: ["Azimut.ECPU и Телефония", "Word и Excel", "Браузер и Плеер", "Telegram и Калькулятор"],
          correctIndex: 0
        },
        {
          question: "Что нужно сделать в первую очередь, если не получается войти в Azimut.ECPU?",
          options: [
            "Удалить программу",
            "Проверить раскладку и Caps Lock и ввести логин/пароль ещё раз",
            "Позвонить клиенту",
            "Сразу звать программиста"
          ],
          correctIndex: 1
        }
      ]
    },

    // 2.2
    {
      id: "op_module_2_2",
      title: "2.2. Раздел «Заказы»: список и статусы",
      short: "Просмотр всех заявок и фильтры",
      description:
        "Научимся открывать раздел «Заказы», видеть все заявки и разбираться в статусах, которые используются в компании.",
      content: [
        { type: "title", text: "Переход в раздел «Заказы»" },
        {
          type: "text",
          text:
            "После входа в программу переходим во вкладку «Заказы» (верхняя панель). " +
            "Здесь отображаются все созданные заявки — как новые, так и старые."
        },
        { type: "image", src: "images/op_22_orders_placeholder.png", caption: "Раздел «Заказы» со списком заявок." },
        { type: "title", text: "Фильтры и поиск заявок" },
        {
          type: "list",
          items: [
            "С помощью полей фильтра можно отфильтровать заявки по дате, статусу, типу и другим параметрам.",
            "Это помогает быстро находить нужную заявку среди большого количества записей."
          ]
        },
        { type: "title", text: "Основные статусы заявки (пример)" },
        {
          type: "list",
          items: [
            "Новый — заявка только что создана и еще не обработана.",
            "Консультация — клиенту дали консультацию, но заявку не оформляли.",
            "Подтверждён — клиент согласен, заявка оформлена, дальше работаем.",
            "В графике — заявка внесена в график выездов мастеров.",
            "Выполнено — работа завершена, заявка закрыта.",
            "Отказ — клиент отказался от оформления заявки или услуги.",
            "Не дозвонились — не удалось связаться с клиентом."
          ]
        }
      ],
      test: [
        {
          question: "В каком разделе отображаются все заявки?",
          options: ["«Телефония»", "«Заказы»", "«Отчёты»", "«Настройки»"],
          correctIndex: 1
        },
        {
          question: "Какой статус подходит для ситуации, когда клиент получил консультацию, но заявку оформлять не стал?",
          options: ["Новый", "Консультация", "Выполнено", "Отказ"],
          correctIndex: 1
        },
        {
          question: "Как оператору быстрее найти нужную заявку среди большого списка?",
          options: ["Проматывать список вручную", "Использовать фильтры и поля поиска", "Попросить мастера найти", "Закрыть программу и открыть снова"],
          correctIndex: 1
        }
      ]
    },

    // 2.3
    {
      id: "op_module_2_3",
      title: "2.3. Номер заявки и комментарии",
      short: "Уникальный номер и внешний комментарий",
      description:
        "Разберёмся, что такое номер заявки, для чего нужен внешний комментарий и как правильно его заполнять.",
      content: [
        { type: "title", text: "Номер заявки" },
        {
          type: "text",
          text:
            "У каждой заявки есть свой уникальный номер. Повторяющихся номеров быть не может. " +
            "По номеру заявки можно быстро найти нужный заказ и проверить историю работы с клиентом."
        },
        { type: "title", text: "Внутренний и внешний комментарий" },
        {
          type: "list",
          items: [
            "Внутренний комментарий — служебная информация для операторов и сотрудников.",
            "Внешний комментарий — то, что видят мастера и, в некоторых случаях, клиент. Поэтому его нужно заполнять аккуратно и по делу."
          ]
        },
        { type: "image", src: "images/op_23_comments_placeholder.png", caption: "«Внешний комментарий» и «Комментарий» в карточке заявки." },
        { type: "title", text: "Как писать комментарии правильно" },
        {
          type: "list",
          items: [
            "Пишем коротко и по сути: что важно знать мастеру перед выездом.",
            "Избегаем лишних эмоций и оценочных суждений.",
            "Если есть важные детали (домофон, код, собака, сложный подъезд) — обязательно указываем.",
            "Телефон клиента лучше продублировать в комментарии, если это предусмотрено методикой."
          ]
        }
      ],
      test: [
        {
          question: "Зачем нужен уникальный номер заявки?",
          options: ["Чтобы красиво смотреться в программе", "Чтобы быстро находить нужный заказ и историю по клиенту", "Чтобы запоминать его наизусть", "Чтобы клиенту было проще жаловаться"],
          correctIndex: 1
        },
        {
          question: "Что такое внешний комментарий?",
          options: [
            "Комментарии, которые видит только программист",
            "Служебная информация для бухгалтерии",
            "Информация, которую видят мастера и которая может распечатываться в документах",
            "Любой текст, который не читают"
          ],
          correctIndex: 2
        }
      ]
    },

    // 2.4
    {
      id: "op_module_2_4",
      title: "2.4. Раздел «Задания» и обработка исходящих звонков",
      short: "Где смотреть задания оператора",
      description:
        "Переходим во вкладку «Задания», учимся открывать назначенные на нас задачи и понимать их статусы.",
      content: [
        { type: "title", text: "Переход в раздел «Задания»" },
        {
          type: "text",
          text:
            "Во вкладке «Задачи и проекты» выбираем раздел «Задания». " +
            "Здесь оператор видит все задачи, назначенные на него: исходящие звонки, которые нужно обработать."
        },
        { type: "image", src: "images/op_24_tasks_placeholder.png", caption: "Раздел «Задания» с примером списка задач." },
        { type: "title", text: "Статусы задач" },
        {
          type: "list",
          items: [
            "Назначено / Не обработано — задача ещё не выполнена, по ней нужно отработать звонок.",
            "Выполнено / Готово — задача обработана, звонок сделан, результат зафиксирован."
          ]
        },
        { type: "title", text: "Открытие заказа из задачи" },
        {
          type: "list",
          items: [
            "Найдите нужную строку с заданием.",
            "Кликните по ней правой кнопкой мыши и выберите «Открыть заказ», либо используйте соответствующую кнопку на панели.",
            "После этого откроется карточка заказа, где можно уточнить детали и внести изменения."
          ]
        }
      ],
      test: [
        {
          question: "Где оператор видит список исходящих задач, назначенных на него?",
          options: ["Во вкладке «Заказы»", "Во вкладке «Телефония»", "Во вкладке «Задачи и проекты» → «Задачи»", "В блокноте на столе"],
          correctIndex: 2
        },
        {
          question: "Какой статус задания говорит о том, что звонок уже отработан?",
          options: ["Назначено / Не обработано", "Выполнено / Готово", "Отказ", "Консультация"],
          correctIndex: 1
        }
      ]
    },
    // 2.5
    {
      id: "op_module_2_5",
      title: "2.5. Карточка заказа: основные поля",
      short: "Что есть в заказе и за что отвечает оператор",
      description:
        "Разберём карточку заказа: номер, тип заказа, список работ, стоимость, адрес, телефоны и историю обращений.",
      content: [
        { type: "title", text: "Основные поля карточки заказа" },
        {
          type: "list",
          items: [
            "Номер заказа — уникальный идентификатор заявки.",
            "Тип заказа — поверка, замена, установка и др.",
            "Список работ — какие работы будут выполняться у клиента.",
            "Стоимость — сумма, которую платит клиент за выбранные работы.",
            "Дата договора — дата оформления заявки.",
            "Адрес — город, улица, дом, квартира.",
            "Телефоны клиента — домашний, городской, мобильный.",
            "История заказов — предыдущие обращения клиента."
          ]
        },
        { type: "image", src: "images/op_25_card_placeholder.png", caption: "Карточка заказа с отмеченными основными полями." },
        { type: "title", text: "Выбор правильного типа заказа" },
        {
          type: "text",
          text:
            "Тип заказа зависит от того, что нужно клиенту: поверка счётчика, замена, установка нового прибора и т.д. " +
            "От правильного выбора типа зависят работы мастера, документы и стоимость."
        },
        { type: "title", text: "Проверка контактных данных" },
        {
          type: "list",
          items: [
            "Проверяем, что указан правильный номер телефона — по нему мастер свяжется перед выездом.",
            "Если есть несколько телефонов, по методике можно дублировать основной номер во внешнем комментарии.",
            "При необходимости проверяем, нет ли дублей по этому телефону или адресу."
          ]
        }
      ],
      test: [
        { question: "Какое поле помогает быстро найти нужную заявку?", options: ["Адрес клиента", "Номер заказа", "ФИО мастера", "Стоимость"], correctIndex: 1 },
        {
          question: "Почему важно правильно выбирать тип заказа (поверка/замена и т.п.)?",
          options: ["Чтобы красиво выглядела карточка", "Чтобы мастеру было удобнее писать отчёт", "От этого зависят работы мастера, документы и стоимость", "Это не имеет значения"],
          correctIndex: 2
        }
      ]
    },

    // 2.6
    {
      id: "op_module_2_6",
      title: "2.6. Звонок клиенту и комментарии",
      short: "Как позвонить и что фиксировать",
      description:
        "Учимся находить номер телефона, звонить клиенту через телефонию и правильно записывать результат разговора в комментариях.",
      content: [
        { type: "title", text: "Поиск номера телефона клиента" },
        {
          type: "list",
          items: [
            "В карточке заказа есть блок с телефонами клиента — домашний, городской, мобильный.",
            "Выбираем актуальный номер (обычно мобильный), при необходимости копируем его.",
            "Проверяем, нет ли дублей по этому номеру в базе (по методике компании)."
          ]
        },
        { type: "image", src: "images/op_26_call_placeholder.png", caption: "Блок с телефонами и примером вызова через телефонию." },
        { type: "title", text: "Звонок клиенту через телефонию" },
        {
          type: "text",
          text:
            "Оператор набирает номер клиента в программе телефонии и ждёт ответа. " +
            "Во время разговора придерживаемся скрипта: представляемся, говорим, из какой компании звоним и по какому вопросу."
        },
        { type: "title", text: "Заполнение комментариев после разговора" },
        {
          type: "list",
          items: [
            "Фиксируем результат разговора: записался клиент или нет, на какое число и время.",
            "Пишем важные детали: как лучше проходить, за сколько минут позвонить, особые пожелания клиента.",
            "Комментарии должны быть понятны любому другому оператору и мастеру."
          ]
        }
      ],
      test: [
        {
          question: "Где оператор смотрит телефоны клиента в карточке заказа?",
          options: ["Внизу экрана в блоке «История»", "В отдельной вкладке браузера", "В блоке с контактными данными клиента в карточке заказа", "В личном телефоне мастера"],
          correctIndex: 2
        },
        {
          question: "Что обязательно нужно сделать после разговора с клиентом?",
          options: ["Сразу закрыть программу", "Удалить заказ", "Записать результат в комментарий и/или статус", "Ничего, программа всё сделает сама"],
          correctIndex: 2
        }
      ]
    },

    // 2.7
    {
      id: "op_module_2_7",
      title: "2.7. Назначение мастера, даты и отказ клиента",
      short: "Интервалы времени и работа с отказами",
      description:
        "Научимся выбирать дату и интервал выезда мастера, предлагать варианты клиенту и правильно оформлять отказ.",
      content: [
        { type: "title", text: "Выбор даты и интервала времени" },
        {
          type: "list",
          items: [
            "Открываем график выездов мастеров и смотрим ближайшие свободные даты.",
            "Предлагаем клиенту интервалы времени (например, 9–13, 13–17, 17–21) в соответствии с методикой компании.",
            "После выбора интервала клиентом фиксируем его в карточке заказа."
          ]
        },
        { type: "image", src: "images/op_27_schedule_placeholder.png", caption: "Выбора даты и временного интервала для мастера." },
        { type: "title", text: "Оформление отказа" },
        {
          type: "list",
          items: [
            "Если клиент отказывается от оформления заявки или от услуги — ставим соответствующий статус (например, «Отказ» или «Консультация»).",
            "В комментарии коротко указываем причину отказа (без лишней оценки клиента).",
            "Важно: нельзя оставлять отказ без статуса и комментария, иначе непонятно, что было по звонку."
          ]
        }
      ],
      test: [
        {
          question: "Как оператор предлагает клиенту время выезда мастера?",
          options: ["Назначает любое время по своему желанию", "Предлагает интервалы времени согласно графику мастеров", "Спрашивает, когда удобно мастеру", "Вообще не обсуждает время"],
          correctIndex: 1
        },
        {
          question: "Что нужно сделать, если клиент отказался от оформления заявки?",
          options: ["Ничего не делать", "Сразу удалить заказ", "Поставить подходящий статус (например, «Отказ») и записать причину в комментарии", "Попросить клиента самому позвонить позже"],
          correctIndex: 2
        }
      ]
    },

    // 2.8
    {
      id: "op_module_2_8",
      title: "2.8. Закрытие задач после обработки",
      short: "Статус задачи и контроль логиста",
      description:
        "Поймём, как правильно закрывать задачи после звонка, чтобы логист и руководство видели, что работа выполнена.",
      content: [
        { type: "title", text: "Почему важно закрывать задачи" },
        {
          type: "list",
          items: [
            "Логист и руководитель видят, какие задачи выполнены, а какие ещё нет.",
            "Незакрытые задачи создают ощущение, что оператор не отработал звонки.",
            "Правильно закрытые задачи помогают избежать повторных обращений и путаницы."
          ]
        },
        { type: "image", src: "images/op_28_done_placeholder.png", caption: "Смены статуса задачи на «Готово» / «Выполнено»." },
        { type: "title", text: "Как закрыть задачу" },
        {
          type: "list",
          items: [
            "Открываем задачу, убеждаемся, что по ней всё выполнено.",
            "Ставим нужный статус (например, «Выполнено» или «Готово»).",
            "Сохраняем изменения.",
            "Проверяем, что задача не висит в списке необработанных."
          ]
        }
      ],
      test: [
        {
          question: "Зачем оператору закрывать задачи после обработки?",
          options: ["Чтобы таблица выглядела красивее", "Чтобы логист видел, что работа по задаче выполнена", "Чтобы заняться чем-то другим", "Это не обязательно"],
          correctIndex: 1
        },
        {
          question: "Что нужно сделать перед тем, как сменить статус задачи на «Выполнено» / «Готово»?",
          options: ["Удалить все комментарии", "Проверить, что по задаче действительно всё выполнено", "Позвонить ещё раз на всякий случай", "Ничего, можно сразу ставить статус"],
          correctIndex: 1
        }
      ]
    },

    // ---------- ДАЛЬШЕ ИДУТ МОДУЛИ ПО ЗВОНКАМ ----------
    {
      id: "op_module_3",
      title: "3. Входящий звонок: структура и скрипт",
      short: "Как вести разговор от приветствия до оформления",
      description:
        "Разберём, как правильно начинать разговор, какие вопросы задавать и как подтверждать заявку.",
      content: [
        { type: "title", text: "Структура входящего звонка" },
        {
          type: "list",
          items: [
            "Приветствие и представление.",
            "Выяснение вопроса клиента.",
            "Сбор информации для заявки.",
            "Оформление и повтор данных.",
            "При необходимости — аккуратная допродажа.",
            "Вежливое завершение разговора."
          ]
        },
        { type: "title", text: "Приветствие" },
        {
          type: "text",
          text:
            "Корректное приветствие: «Добрый день, компания ООО «ЕЦПУ», меня зовут [Имя], слушаю вас». " +
            "Не используем грубые или слишком короткие варианты вроде «Алло?» или «Да?»."
        },
        { type: "title", text: "Сбор информации" },
        {
          type: "list",
          items: [
            "Адрес клиента.",
            "Телефон для связи.",
            "Вид услуги: поверка, замена или установка.",
            "Количество счётчиков.",
            "Удобное время визита.",
            "Особенности: домофон, код, этаж, наличие животных и т.п."
          ]
        },
        { type: "title", text: "Подтверждение заявки" },
        {
          type: "text",
          text:
            "После заполнения заявки оператор повторяет ключевую информацию: " +
            "«Повторю: заявка на поверку [количество] счётчиков по адресу [адрес] на [дата/время]. " +
            "Мастер свяжется с вами по телефону [номер]. Всё верно?»."
        },
        { type: "title", text: "Завершение разговора" },
        { type: "text", text: "После подтверждения заявки благодарим клиента: «Спасибо за обращение в ООО «ЕЦПУ». Хорошего дня»." }
      ],
      test: [
        {
          question: "Какое приветствие корректно для оператора?",
          options: ["«Алло»", "«Да?»", "«Добрый день, компания ООО «ЕЦПУ», меня зовут [Имя], слушаю вас.»", "«Говорите быстрее»"],
          correctIndex: 2
        },
        {
          question: "Какие данные обязательно нужно уточнить при оформлении заявки на поверку?",
          options: ["Марку телефона клиента", "Адрес, телефон, вид услуги и количество счётчиков", "Знак зодиака клиента", "Есть ли у клиента машина"],
          correctIndex: 1
        },
        {
          question: "Клиент сказал: «Мне нужна поверка счётчиков воды». Что оператор делает в первую очередь?",
          options: ["Сразу называет цену, не задавая вопросов", "Говорит, что всё занято", "Уточняет адрес, телефон и количество счётчиков", "Переключает звонок на мастера"],
          correctIndex: 2
        }
      ]
    },
    {
      id: "op_module_4",
      title: "4. Кросс-продажи сантехники и электрики",
      short: "Как мягко предлагать доп. услуги",
      description:
        "Научимся аккуратно предлагать дополнительные работы по сантехнике и электрике, не затягивая разговор и не давя на клиента.",
      content: [
        { type: "title", text: "Когда предлагать дополнительные услуги" },
        {
          type: "list",
          items: [
            "После того как основная заявка уже оформлена.",
            "Не в начале разговора и не во время жалоб клиента.",
            "Когда клиент спокоен и согласен с основной услугой."
          ]
        },
        { type: "title", text: "Как предлагать — пример формулировки" },
        {
          type: "text",
          text:
            "Пример: «Раз мастер всё равно будет у вас, он может заодно посмотреть состояние кранов и гибких подводок, " +
            "чтобы избежать протечек. Ничего по сантехнике не беспокоит?»."
        },
        {
          type: "text",
          text:
            "По электрике: «Мастер также занимается электрикой — щиток, автоматы, розетки. " +
            "Если есть что-то, что давно хотели проверить или заменить, сейчас самое удобное время»."
        },
        { type: "title", text: "Чего нельзя делать при кросс-продаже" },
        {
          type: "list",
          items: [
            "Нельзя пугать клиента: «у вас всё развалится», «точно затопит» без оснований.",
            "Нельзя давить и настаивать, если клиент отказывается.",
            "Нельзя обещать несуществующие скидки или услуги, которых компания не оказывает."
          ]
        },
        { type: "title", text: "Если клиент говорит: «Нет, ничего не нужно»" },
        {
          type: "text",
          text:
            "Корректный ответ: «Хорошо, оформляю только основную услугу. " +
            "Если что-то вспомните — можете сказать мастеру при визите»."
        }
      ],
      test: [
        {
          question: "Когда лучше всего предлагать дополнительные услуги?",
          options: ["В начале разговора, до оформления заявки", "Во время жалоб клиента", "После того, как основная заявка уже оформлена", "Вообще не предлагать"],
          correctIndex: 2
        },
        {
          question: "Какая фраза корректна для кросс-продажи сантехники?",
          options: [
            "«Давайте я вам ещё что-нибудь впарю»",
            "«У вас всё сломается, если прямо сейчас не сделаете ремонт»",
            "«Раз мастер всё равно к вам приедет, он может заодно посмотреть состояние кранов и подводок, чтобы избежать протечек. Ничего по сантехнике не беспокоит?»",
            "«Ну чё, ремонт делать будем?»"
          ],
          correctIndex: 2
        },
        {
          question: "Клиент говорит: «Нет, ничего больше не нужно». Как правильнее ответить?",
          options: ["«Ну и зря»", "«Ладно, как хотите»", "«Хорошо, оформляю только поверку. Если что-то вспомните — можете сказать мастеру на месте»", "Сразу положить трубку"],
          correctIndex: 2
        }
      ]
    },

    {
      id: "op_module_5",
      title: "5. Исходящие звонки",
      short: "Звонки клиентам: напоминания и предложения",
      description:
        "Разберём, как правильно звонить клиенту первым: по срокам поверки, предложениям по замене и другим случаям.",
      content: [
        { type: "title", text: "Зачем оператор делает исходящие звонки" },
        {
          type: "list",
          items: [
            "Подходит срок поверки счётчика.",
            "Предложение заменить старый счётчик.",
            "Напоминание о визите мастера.",
            "Информирование об акциях и предложениях, если это предусмотрено правилами компании."
          ]
        },
        { type: "title", text: "Начало разговора при исходящем звонке" },
        {
          type: "text",
          text:
            "Корректное начало: «Добрый день, это компания ООО «ЕЦПУ», меня зовут [Имя]. " +
            "Раньше вы обращались к нам по поводу счётчиков. Звоню, потому что [причина звонка]»."
        },
        { type: "title", text: "Краткий сценарий исходящего звонка" },
        {
          type: "list",
          items: [
            "Представиться и назвать компанию.",
            "Напомнить, откуда у нас контакт клиента (раньше обращался).",
            "Коротко объяснить причину звонка и суть предложения.",
            "Спросить, интересно ли клиенту предложение.",
            "Если да — оформить заявку.",
            "Если нет — вежливо завершить разговор."
          ]
        },
        { type: "title", text: "Работа с возражениями" },
        {
          type: "list",
          items: [
            "«Неинтересно» — поблагодарить за время и оставить возможность обратиться в будущем.",
            "«Дорого» — при необходимости пояснить, что входит в услугу (если у компании есть скрипт).",
            "«Сделаю потом» — зафиксировать, что сейчас заявку не оформляем.",
            "Во всех случаях оставаться вежливым, не спорить и не давить."
          ]
        }
      ],
      test: [
        {
          question: "Что первым делом должен сказать оператор при исходящем звонке?",
          options: ["«Записывайте наш супервыгодный тариф!»", "«Алло, угадайте кто?»", "«Добрый день, это компания ООО «ЕЦПУ», меня зовут [Имя]. Раньше вы обращались к нам по поводу счётчиков.»", "«У вас есть минутка?»"],
          correctIndex: 2
        },
        {
          question: "Клиент говорит: «Мне неинтересно». Как корректнее ответить?",
          options: ["«Ну и зря»", "«Это ваши проблемы»", "«Понимаю, тогда записывать заявку не буду. Если передумаете — можете всегда обратиться к нам по этому номеру»", "Сразу положить трубку"],
          correctIndex: 2
        }
      ]
    }
  ],

  masterNewbie: [
    {
      id: "m_module_1",
      title: "1. Вход в личный кабинет",
      short: "Логин/пароль и вход",
      description: "Учимся заходить в личный кабинет мастера и что делать, если вход не получается.",
      content: [
        { type: "title", text: "Вход в личный кабинет мастера" },
        { type: "text", text: "Откройте личный кабинет мастера, введите логин и пароль и нажмите «Вход». Логин/пароль — персональные, никому не передавать." },
        { type: "image", src: "images/m_01_login.png", caption: "Экран входа в личный кабинет мастера." },
        { type: "title", text: "Если не заходит" },
        { type: "list", items: ["Проверьте раскладку клавиатуры и Caps Lock.", "Введите логин/пароль ещё раз без пробелов.", "Если не помогло — сообщите старшему/админу."] }
      ],
      test: [
        { question: "Что делать в первую очередь, если не получается войти?", options: ["Сразу нажать «В обработку»", "Проверить раскладку/Caps Lock и ввести логин/пароль ещё раз", "Удалить браузер", "Попросить пароль у коллеги"], correctIndex: 1 }
      ]
    },

    {
      id: "m_module_2",
      title: "2. Геолокация: разрешение обязательно",
      short: "Подтверждение гео",
      description: "Разбираемся с запросом геопозиции и почему его нужно разрешить.",
      content: [
        { type: "title", text: "Запрос геопозиции" },
        { type: "text", text: "При входе система может попросить доступ к геолокации. Это нужно для корректной работы." },
        { type: "image", src: "images/m_02_geo_permission.png", caption: "Запрос на использование геопозиции." },
        { type: "title", text: "Правило" },
        { type: "list", items: ["Нажимаем «Разрешить».", "Если запретить — часть функций может работать некорректно."] }
      ],
      test: [
        { question: "Что делать при запросе геолокации?", options: ["Нажать «Не разрешать» всегда", "Нажать «Разрешить»", "Закрыть вкладку", "Перезагрузить телефон"], correctIndex: 1 }
      ]
    },
    {
      id: "m_module_3",
      title: "3. Начало рабочего дня и маршрутный лист",
      short: "Старт из офиса/дома",
      description: "Учимся начинать рабочий день и понимать, где маршрутный лист.",
      content: [
        { type: "title", text: "Начать рабочий день" },
        { type: "text", text: "Перед выездами мастер начинает рабочий день: «из офиса» или «из дома» (как положено по факту)." },
        { type: "image", src: "images/m_03_start_day.png", caption: "Экран начала рабочего дня и доступ к маршрутному листу." },
        { type: "title", text: "Маршрутный лист" },
        { type: "list", items: ["Маршрутный лист помогает видеть план на день.", "Перед выездом проверьте список заявок и комментарии."] }
      ],
      test: [
        { question: "Что нужно сделать перед выездом по заявкам?", options: ["Сразу ехать, не читая", "Начать рабочий день и проверить список заявок/комментарии", "Написать клиенту в WhatsApp", "Нажать «В обработку»"], correctIndex: 1 }
      ]
    },

    {
      id: "m_module_4",
      title: "4. Список заявок: открыть и прочитать",
      short: "Где кнопка «Открыть»",
      description: "Разбираемся со списком заявок: где смотреть, что открывать и что читать перед выездом.",
      content: [
        { type: "title", text: "Список заявок" },
        { type: "text", text: "В списке заявок мастер видит заказы. Нажимаем «Открыть», чтобы перейти в карточку заявки и прочитать комментарий." },
        { type: "image", src: "images/m_04_orders_list.png", caption: "Список заявок и кнопка «Открыть»." },
        { type: "title", text: "Мини-чек перед выездом" },
        { type: "list", items: ["Адрес и район.", "Телефон клиента.", "Время, когда клиент ждёт.", "Комментарий — обязательно."] }
      ],
      test: [
        { question: "Что обязательно прочитать перед выездом?", options: ["Только цену", "Только район", "Комментарий и время ожидания клиента", "Ничего"], correctIndex: 2 }
      ]
    },

    {
      id: "m_module_5",
      title: "5. Карточка заявки: что проверяем обязательно",
      short: "Номер/статус/адрес/телефон/коммент",
      description: "Учимся читать карточку заявки и понимать, что мастер обязан проверить.",
      content: [
        { type: "title", text: "Карточка заявки" },
        { type: "image", src: "images/m_05_order_top.png", caption: "Номер, статус, адрес, телефон, вид работ, комментарий, время ожидания." },
        { type: "title", text: "Кнопка «В обработку» — ЗАПРЕЩЕНО" },
        { type: "text", text: "Важно: кнопку «Направить в обработку» нажимать запрещено. Всегда." },
        { type: "title", text: "Что проверяем" },
        { type: "list", items: ["Номер заявки и статус.", "Адрес (дом/корпус/квартира).", "Телефон клиента.", "Вид работ по заявке.", "Комментарий и время ожидания."] }
      ],
      test: [
        { question: "Что сказано про кнопку «В обработку»?", options: ["Можно нажимать, если торопишься", "Нажимать запрещено", "Нажимать только новичкам", "Нажимать, если клиент попросил скидку"], correctIndex: 1 }
      ]
    },

    {
      id: "m_module_6",
      title: "6. Стоимость и добавление работ",
      short: "Добавить работы по факту",
      description: "Разбираемся, где стоимость и как добавлять работы, если клиенту реально понадобилось.",
      content: [
        { type: "title", text: "Стоимость и работы" },
        { type: "image", src: "images/m_06_add_works.png", caption: "Блок стоимости и добавления работ." },
        { type: "title", text: "Правило добавления работ" },
        { type: "list", items: ["Добавляем только то, что реально потребуется клиенту.", "Обязательно проговариваем клиенту стоимость ДО выполнения.", "Никаких «накину потом». Всё прозрачно."] }
      ],
      test: [
        { question: "Когда можно добавлять дополнительные работы?", options: ["Всегда, чтобы чек был больше", "Только если клиенту реально нужно и он согласовал стоимость", "Никогда", "Только после выполнения"], correctIndex: 1 }
      ]
    },
    {
      id: "m_module_7",
      title: "7. Фото, деньги и кнопка «Выполнить»",
      short: "Фото + итоги + выполнение",
      description: "Учимся добавлять фото, понимать суммы и корректно завершать заявку.",
      content: [
        { type: "title", text: "Фото и итоги" },
        { type: "image", src: "images/m_07_photos_money_done.png", caption: "Добавление фото, суммы, зарплата и кнопка выполнения заказа." },
        { type: "title", text: "Перед «Выполнить»" },
        { type: "list", items: ["Все нужные работы добавлены.", "Фото добавлены (если требуется по правилам).", "Сумма к получению с клиента корректна."] }
      ],
      test: [
        { question: "Что важно проверить перед нажатием «Выполнить»?", options: ["Только заряд телефона", "Что заполнены работы/фото/итоги и суммы корректны", "Ничего", "Что клиент улыбается"], correctIndex: 1 }
      ]
    },

    {
      id: "m_module_8",
      title: "8. Выполненная заявка: как выглядит финал",
      short: "Статус «Выполнено»",
      description: "Понимаем, как выглядит завершённая заявка и что считается финалом.",
      content: [
        { type: "title", text: "Выполнено" },
        { type: "image", src: "images/m_08_completed.png", caption: "Пример выполненной заявки." },
        { type: "title", text: "Финальный чек" },
        { type: "list", items: ["Статус: выполнено.", "Данные по работам и суммам на месте.", "Фото (если нужно) добавлены."] }
      ],
      test: [
        { question: "Что считается корректным завершением заявки?", options: ["Просто уехать", "Поставить «Выполнено» и убедиться, что всё заполнено", "Нажать «В обработку»", "Оставить без статуса"], correctIndex: 1 }
      ]
    }
  ]
};

// ====== ПРОГРЕСС (localStorage) ======

const STORAGE_KEY = "ecpu_training_progress";

function loadProgress() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { operator: { completed: [] }, masterNewbie: { completed: [] } };
    const parsed = JSON.parse(raw);
    if (!parsed.operator) parsed.operator = { completed: [] };
    if (!parsed.masterNewbie) parsed.masterNewbie = { completed: [] };
    return parsed;
  } catch {
    return { operator: { completed: [] }, masterNewbie: { completed: [] } };
  }
}

function saveProgress(progress) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
}

// ====== РЕНДЕР ПРИЛОЖЕНИЯ ======

const appRoot = document.getElementById("app");

let state = {
  role: null, // 'operator' | 'masterNewbie'
  screen: "roleSelect", // 'roleSelect' | 'modules' | 'lesson' | 'test'
  currentModuleId: null,
  testResult: null
};

function roleLabel(role) {
  if (role === "operator") return "Оператор";
  if (role === "masterNewbie") return "Мастер (новичок)";
  return "Роль";
}

function getCurrentModules() {
  if (state.role === "operator") return lessonsData.operator;
  if (state.role === "masterNewbie") return lessonsData.masterNewbie;
  return [];
}

function getModuleById(id) {
  return getCurrentModules().find((m) => m.id === id);
}

function isModuleCompleted(id) {
  const progress = loadProgress();
  const roleProgress = progress[state.role] || { completed: [] };
  return roleProgress.completed.includes(id);
}

function canOpenModule(index) {
  if (index === 0) return true;
  const modules = getCurrentModules();
  const prev = modules[index - 1];
  return isModuleCompleted(prev.id);
}

// ====== ЭКРАНЫ ======

function render() {
  if (state.screen === "roleSelect") renderRoleSelect();
  else renderShell();
}

function renderRoleSelect() {
  appRoot.innerHTML = `
    <div class="app-shell">
      <div class="app-header">
        <div class="app-title-group">
          <div class="app-title">
            Обучение сотрудников
            <span class="app-title-pill">ООО «ЕЦПУ»</span>
          </div>
          <div class="app-subtitle">Выберите вашу роль, чтобы начать обучение</div>
        </div>
      </div>
      <div class="role-select-screen">
        <div class="role-cards">
          <div class="role-card" data-role="operator">
            <span class="role-tag">Доступно</span>
            <div class="role-card-title">Оператор</div>
            <div class="role-card-sub">
              Звонки, оформление заявок и работа в программе Azimut.ECPU.
            </div>
          </div>

          <div class="role-card" data-role="masterNewbie">
            <span class="role-tag">Доступно</span>
            <div class="role-card-title">Мастер (новичок)</div>
            <div class="role-card-sub">
              Личный кабинет мастера: гео, заявки, добавление работ, фото, закрытие заказа.
            </div>
          </div>

          <div class="role-card disabled">
            <span class="role-tag">Скоро</span>
            <div class="role-card-title">Мастер (допщик)</div>
            <div class="role-card-sub">
              Продажи доп. услуг на выезде: сантехника и электрика.
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  const operatorCard = appRoot.querySelector('[data-role="operator"]');
  operatorCard.addEventListener("click", () => {
    state.role = "operator";
    state.screen = "modules";
    state.currentModuleId = null;
    state.testResult = null;
    render();
  });

  const masterCard = appRoot.querySelector('[data-role="masterNewbie"]');
  masterCard.addEventListener("click", () => {
    state.role = "masterNewbie";
    state.screen = "modules";
    state.currentModuleId = null;
    state.testResult = null;
    render();
  });
}

function renderShell() {
  const modules = getCurrentModules();
  const currentModule = state.currentModuleId ? getModuleById(state.currentModuleId) : null;

  const progress = loadProgress();
  const roleProgress = progress[state.role] || { completed: [] };

  const sidebarItemsHtml = modules
    .map((m, index) => {
      const completed = roleProgress.completed.includes(m.id);
      const locked = !canOpenModule(index);
      const active = currentModule && currentModule.id === m.id;

      let statusText = "Не начат";
      if (completed) statusText = "Пройдено";
      else if (active) statusText = "Сейчас";
      const pillClass = completed
        ? "sidebar-status-pill done"
        : locked
        ? "sidebar-status-pill locked"
        : "sidebar-status-pill";

      return `
        <div class="sidebar-item ${active ? "active" : ""}" data-module-id="${m.id}" data-locked="${locked}">
          <div class="sidebar-item-label">
            <div class="sidebar-item-main">${index + 1}. ${m.title}</div>
            <div class="sidebar-item-sub">${m.short}</div>
          </div>
          <div class="${pillClass}">${statusText}</div>
        </div>
      `;
    })
    .join("");

  let mainContentHtml = "";
  if (state.screen === "modules") mainContentHtml = renderModulesScreenInner(modules, roleProgress);
  else if (state.screen === "lesson" && currentModule) mainContentHtml = renderLessonScreenInner(currentModule);
  else if (state.screen === "test" && currentModule) mainContentHtml = renderTestScreenInner(currentModule);

  appRoot.innerHTML = `
    <div class="app-shell">
      <div class="app-header">
        <div class="app-title-group">
          <div class="app-title">
            Обучение сотрудников
            <span class="app-title-pill">ООО «ЕЦПУ»</span>
          </div>
          <div class="app-subtitle">
            ${state.role === "operator" ? "Телефония, заявки и работа с клиентами" : "Личный кабинет мастера и закрытие заявок"}
          </div>
        </div>
        <div class="app-role-badge">Роль: ${roleLabel(state.role)}</div>
      </div>

      <div class="app-content">
        <aside class="sidebar">
          <div class="sidebar-title">Модули</div>
          ${sidebarItemsHtml}
        </aside>

        <main class="main-panel">
          ${mainContentHtml}
        </main>
      </div>
    </div>
  `;
  appRoot.querySelectorAll(".sidebar-item").forEach((el) => {
    const moduleId = el.getAttribute("data-module-id");
    const locked = el.getAttribute("data-locked") === "true";
    if (!moduleId || locked) return;

    el.addEventListener("click", () => {
      state.currentModuleId = moduleId;
      state.screen = "lesson";
      state.testResult = null;
      render();
    });
  });
}

function renderModulesScreenInner(modules, roleProgress) {
  const completedCount = (roleProgress.completed || []).length;
  const total = modules.length;

  return `
    <div class="breadcrumbs">${roleLabel(state.role)} · Обучающие модули</div>
    <div class="main-heading">План обучения</div>
    <div class="main-description">
      Проходите модули последовательно: каждый следующий открывается после успешного теста по предыдущему.
      Сейчас пройдено модулей: ${completedCount} из ${total}.
    </div>

    <div class="block">
      <div class="block-title">Как работать с модулями</div>
      <ul class="block-list">
        <li>Откройте первый модуль, внимательно прочитайте материалы.</li>
        <li>После чтения перейдите к тесту и ответьте на вопросы.</li>
        <li>Если допустите ошибки — вернитесь к уроку, перечитайте и пройдите тест ещё раз.</li>
        <li>После успешной сдачи теста откроется следующий модуль.</li>
      </ul>
    </div>
  `;
}

function renderLessonScreenInner(module) {
  const contentBlocks = module.content
    .map((block) => {
      if (block.type === "title") {
        return `<div class="block"><div class="block-title">${block.text}</div></div>`;
      }
      if (block.type === "text") {
        return `<div class="block"><div>${block.text}</div></div>`;
      }
      if (block.type === "list") {
        const itemsHtml = block.items.map((item) => `<li>${item}</li>`).join("");
        return `<div class="block"><ul class="block-list">${itemsHtml}</ul></div>`;
      }
      if (block.type === "image") {
        const caption = block.caption || "";
        return `
          <div class="block block-image">
            <img src="${block.src}" alt="${caption}" />
            ${caption ? `<div class="block-image-caption">${caption}</div>` : ""}
          </div>
         `;
      }
      return "";
    })
    .join("");

  return `
    <div class="breadcrumbs">${roleLabel(state.role)} · ${module.title}</div>
    <div class="main-heading">${module.title}</div>
    <div class="main-description">${module.description}</div>
    ${contentBlocks}
    <div class="btn-row">
      <button class="btn" data-action="backToModules">К списку модулей</button>
      <button class="btn btn-primary" data-action="toTest">Перейти к тесту</button>
    </div>
  `;
}

function renderTestScreenInner(module) {
  const questionsHtml = module.test
    .map((q, qi) => {
      const optionsHtml = q.options
        .map(
          (opt, oi) => ` 
          <label class="test-option" data-question-index="${qi}" data-option-index="${oi}">
            <input type="radio" name="q${qi}" value="${oi}" />
            <span>${opt}</span>
          </label>
        `
        )
        .join("");

      return `
        <div class="test-question">
          <div class="test-question-title">${qi + 1}. ${q.question}</div>
          <div class="test-options">${optionsHtml}</div>
        </div>
      `;
    })
    .join("");

  let messageHtml = "";
  if (state.testResult) {
    messageHtml = state.testResult.success
      ? `<div class="message message-success">Отлично! Все ответы верные. Модуль отмечен как пройден.</div>`
      : `<div class="message message-error">Есть ошибки. Вернитесь к уроку, перечитайте материал и попробуйте ещё раз.</div>`;
  }

  const buttonsHtml = state.testResult?.success
    ? `
      <div class="btn-row">
        <button class="btn" data-action="backToLesson">Вернуться к уроку</button>
        <button class="btn btn-primary" data-action="backToModules">К списку модулей</button>
      </div>
    `
    : `
      <div class="btn-row">
        <button class="btn" data-action="backToLesson">Вернуться к уроку</button>
        <button class="btn btn-primary" data-action="checkTest">Проверить ответы</button>
      </div>
    `;

  setTimeout(() => attachTestHandlers(module), 0);

  return `
    <div class="breadcrumbs">${roleLabel(state.role)} · ${module.title} · Тест</div>
    <div class="main-heading">Тест по модулю</div>
    <div class="main-description">
      Ответьте на вопросы. Если допустите ошибки — вернитесь к уроку и повторите материал.
    </div>
    ${questionsHtml}
    ${messageHtml}
    ${buttonsHtml}
  `;
}

// ====== Обработчики теста ======

function attachTestHandlers(module) {
  const mainPanel = appRoot.querySelector(".main-panel");
  if (!mainPanel) return;

  mainPanel.querySelectorAll('.btn[data-action="checkTest"]').forEach((btn) => {
    btn.addEventListener("click", () => {
      const result = checkTestAnswers(module);
      state.testResult = { success: result.success };

      if (result.success) {
        const progress = loadProgress();
        if (!progress[state.role]) progress[state.role] = { completed: [] };
        if (!progress[state.role].completed.includes(module.id)) {
          progress[state.role].completed.push(module.id);
        }
        saveProgress(progress);
      }
      render();
    });
  });

  mainPanel.querySelectorAll('.btn[data-action="backToLesson"]').forEach((btn) => {
    btn.addEventListener("click", () => {
      state.screen = "lesson";
      render();
    });
  });

  mainPanel.querySelectorAll('.btn[data-action="backToModules"]').forEach((btn) => {
    btn.addEventListener("click", () => {
      state.screen = "modules";
      state.currentModuleId = null;
      state.testResult = null;
      render();
    });
  });
}

function checkTestAnswers(module) {
  const mainPanel = appRoot.querySelector(".main-panel");
  if (!mainPanel) return { success: false };

  let allCorrect = true;

  mainPanel.querySelectorAll(".test-option").forEach((opt) => {
    opt.classList.remove("wrong", "correct");
  });

  module.test.forEach((q, qi) => {
    const selected = mainPanel.querySelector(`input[name="q${qi}"]:checked`);
    if (!selected) {
      allCorrect = false;
      return;
    }

    const selectedIndex = parseInt(selected.value, 10);
    const options = mainPanel.querySelectorAll(`.test-option[data-question-index="${qi}"]`);

    options.forEach((optEl) => {
      const oi = parseInt(optEl.getAttribute("data-option-index"), 10);
      if (oi === q.correctIndex) optEl.classList.add("correct");
      if (oi === selectedIndex && selectedIndex !== q.correctIndex) {
        optEl.classList.add("wrong");
        allCorrect = false;
      }
    });
  });

  return { success: allCorrect };
}

// ====== Глобальные обработчики кнопок ======

document.addEventListener("click", (e) => {
  const btn = e.target.closest(".btn");
  if (!btn) return;

  const action = btn.getAttribute("data-action");
  if (!action) return;

  if (action === "backToModules") {
    state.screen = "modules";
    state.currentModuleId = null;
    state.testResult = null;
    render();
  } else if (action === "toTest") {
    state.screen = "test";
    state.testResult = null;
    render();
  } else if (action === "backToLesson") {
    state.screen = "lesson";
    state.testResult = null;
    render();
  }
});

// ====== ИНИЦИАЛИЗАЦИЯ ======

function init() {
  if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.expand();
  }
  render();
}

init();
